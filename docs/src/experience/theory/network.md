---
title: 网络协议
description: 网络协议
---

# 网络协议面试题

## TCP中三次握手和四次挥手

### TCP 三次握手

TCP 协议中三次握手用于建立一个可靠的连接。具体步骤如下：

1. **SYN**：客户端向服务端发送一个 SYN（同步序列编号）包，表示客户端希望建立连接，并告知服务端初始序列号（Sequence Number）。

2. **SYN-ACK**：服务器收到 SYN 包后，响应一个包含 SYN 和 ACK（确认）标志的包，表示同意建立连接，并向客户端发送服务器的初始序列号。

3. **ACK**：客户端收到 SYN-ACK 包后，发送一个 ACK 包，确认已收到服务器的 SYN包。此时，三次握手完成，连接建立。

在三次握手中，序列号的使用是为了确保每个数据包的唯一性和顺序性。

### TCP 四次挥手

TCP 四次挥手用于终止连接。具体步骤如下：

1. **FIN**：客户端发送一个 FIN（终止）包，表示它希望终止连接。

2. **ACK**：服务器收到 FIN 包后，发送一个 ACK包，确认已收到终止请求。

3. **FIN**：服务器也发送一个 FIN 包，表示它也希望终止连接。

4. **ACK**：客户端收到服务器的 FIN 包后，发送一个 ACK 包，确认已收到服务器的终止请求。此时，连接正式关闭。

## 讲一下 HTTP/2 的多路复用

在 HTTP/1 中，每次请求都会建立一次 HTTP 连接，也就是我们常说的3次握手4次挥手，这个过程在一次请求中占用了相当长的时间，即使开启了 Keep-Alive，解决了多次连接的问题，但依然有两个效率上的问题：

* 第一个：串行的文件传输。当请求a文件时，b文件只能等待，等待a连接到服务器、服务器处理文件、服务器返回文件这三个步骤。我们假设这三步用时都是1s，那么a文件用时为3s，b文件传输完成用时为6s。

* 第二个：连接数过多。假设 Apache 设置了最大并发数为300。因为浏览器限制，浏览器发起的最大请求数为6，也就是服务器能承载的最高并发为50，当第51个人访问时，就需要等待前面的某个请求处理完成。

HTTP/2 的多路复用就是为了解决上述的两个性能问题。

在 HTTP/2 中有两个非常重要的概念，分别是帧（frame）和流（stream）。

帧代表着最小的数据单位，每个帧都会标识出该帧属于哪个流，留也就是多个帧组成的数据流。

多路复用，就是在一个 TCP 连接中可以存在多个流。也就是可以发送多个请求，对端可以通过帧中的标识知道属于哪个请求。通过这个技术，可以避免 HTTP 旧版本中队头阻塞问题，极大的提高传输性能。

## 帧是如何标记属于哪个流的

在 HTTP/2 中，每个帧都会有一个包含流标识符的字段，用于标记该帧属于哪个流。这些帧在同一个连接中传输，并通过流标识符区分它们的归属。具体来说，每个帧头部包含一个 31 位的流标识符字段，该字段标识了该帧所属的流。流标识符为 0 的帧是保留给特定用途的控制帧。

## 如果A 与 B 建立了正常连接后，从未相互发过数据，这个时候 B 突然机器重启，问 A 此时处于 TCP 什么状态？如何消除服务器程序中的这个状态？

在A和B建立正常连接后，如果B突然重启而从未相互传输数据，此时A的TCP连接状态会保持不变，处于`ESTABLISHED`状态。A的操作系统不会立即知道B已经重启，因为没有任何数据传输来触发连接状态的改变。通常，A需要通过发送或接收数据来检测到连接异常。

为了消除服务器程序中的这种状态，可以采取以下方法：

* 设置`SO_KEEPALIVE`选项：通过setsockopt函数开启TCP连接的Keep-Alive功能，这样可以定期发送Keep-Alive探测包来检测对方是否仍然在线。不过默认的Keep-Alive时间间隔可能较长，可以根据需要调整。

* 使用非阻塞模式和`select()`函数：将socket设置为非阻塞模式，并使用select()或poll()来监控socket的可读性或可写性，可以设定超时时间来避免长时间等待。

* 检测发送错误：当对端重启时，发送数据通常会导致发送错误，应用程序可以根据发送操作的返回值来判断并处理连接断开。

当看到连接状态为`ESTABLISHED`，开发者可以确信两端已经建立了可靠的连接，并可以开始数据传输。
